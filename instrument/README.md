# Instrument


## Test page

https://aberke.github.io/fingerprinting-study/instrument/index.html?showdata=true


Use URL parameters for showdata true/false:
- ?showdata=true (default)
- ?showdata=false


## Custom software Qualtrics integration

Custom software was developed to make the page where users consent to share browser attributes data.

This only works given a specific survey set up described below and is quirky in order to work around Qualtrics quirks.

Overview:

We use qualtrics and hack together both the [Javascript Questions API](https://api.qualtrics.com/82bd4d5c331f1-qualtrics-java-script-question-api-class) and the [Response API](https://api.qualtrics.com/354c312da7cc7-survey-responses).

When respondents consent to share their browser attributes data, they do so with a Qualtrics multiple choice question type. In the background we then upload a csv file with the shared browser attributes data.

The csv file is saved as a separate survey response where the file is named with the responseId of the participant who shared the data.

The result is 1-2 responses per respondent.

1. Survey responses for questions the respondant filled out in the survey. It excludes the file upload.

2. Only included if the participant consented to sharing their browser attributes data. These responses only contain file uploads. The ResponseId generated by Qualtrics is different but the file name corresponds to the ResponseId for the participant who shared the file.

Here is how we do this (can skip why):

## Set up 

This requires a quirky set up in Qualtrics to make this work.


### Invisible File Upload

We upload data files to an invisible file upload question.

#### Steps:
- Create as the first question: A file upload question type.
- Make the question always hidden. Can do this via display logic: Display question with true/false --> set to false. (Preview survey to make sure hidden)
- Get the __FQID__: Capture the Question ID for the file upload question. Call this the __FQID__: It is of form QID{int}. It is NOT the same as the Q{int} name shown in the survey builder. A few ways to get it. Can get the FQID value using the [piped text feature](https://www.qualtrics.com/support/survey-platform/survey-module/editing-questions/piped-text/piped-text-overview/#PipingFromAPreviousQuestion):
    - click to edit the question
    - click Piped Text > Survey Question
    - edit this survey question. Select anything (File Name)
    - See in the question: ${q://{FQID}/UploadedFileName}


Why do it this way?
- we want a file upload question type / endpoint to save files to
- we don't want respondents to directly upload files using the qualtrics file upload question type because:
    - we need to parse the files in the browser to strip data and present the data to the user
    - we want the respondent to answer whether they consent to sharing their data and upload the file based on the consent (i.e. use the multiple choice question type)
    - qualtrics immediately uploads files to the server upon the respondent putting them in a file field
    - not only does this go against what we say about not saving any user data without full consent first, qualtrics also then removes the file from the file field so we don't have easy access to it: problem
    - so we create our own file input field in the multiple choice question type and then use this invisible question as an API endpoint to send files to.

### Set embedded data

We set embedded data (some specific to this survey) to get and use in the questions.

#### Steps:
- Go into Survey Flow.
- Add new element > Embedded data
- Move the elemnt to the top of the survey flow
- Use Add New Field to set the embedded data elements:
- SurveyID: from Survey Metadata
- ResponseID: from Survey Metadata (not RID)
- FQID: Custom value from above
- API_TOKEN: Custom value



## Data share question

We use the multiple choice question type.

### Question choice codes

Make sure the question choice values are recoded as follows.

- 1 = Consent to share
- 0 = Decline

Steps:
- click on the question
- click Button behavior > x -> Recode values

Why?
- we only upload the data if Yes -- need to get value via JS upon question submission.

### Question HTML and JS

The question we show participants with the embedded JS functionality is created via editing the question using the HTML editor. 

Insert:

```
[CSS]
[HTML]
<!-- JS libraries  -->
<script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
<script src="https://aberke.github.io/fingerprinting-study/instrument/fpjs.js"></script>
```

Dump the contents of our JS script into the Qualtrics question JavaScript editor:

```
Qualtrics.SurveyEngine.addOnload(function() {

    // all of our JavaScript

});
```

Why work with JS this way? 
- It must be done this way to make the advertised Qualtrics.SurveyEngine APIs work properly. 
- Why not put our JS into external scripts like the libraries?  Many hours went into trying to make this work otherwise via external scripts. 
- The API interface does not seem to properly work outside of the JS editing interface Qualtrics provides.
